name: Deploy Django App to Kubernetes

on:
  push:
    branches: [ main ]

env:
  K8S_NAMESPACE: django-app

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Run Django checks
      run: |
        python manage.py check
        python manage.py makemigrations --check --dry-run
    - name: Test Docker build locally
      run: |
        docker build -t django-app-test .

  deploy:
    needs: test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Build local Docker image
      run: |
        echo "ğŸ³ Building local Docker image..."
        docker build -t django-kubernetes-app:local .
        echo "âœ… Local image built successfully"
        
    - name: Verify Kubernetes cluster
      run: |
        echo "ğŸ” Verifying Kubernetes cluster..."
        kubectl cluster-info
        kubectl get nodes
        echo "âœ… Kubernetes cluster is accessible"
        
    - name: Apply Kubernetes configuration
      run: |
        echo "ğŸš€ Applying Kubernetes manifests..."
        kubectl apply -f k8s-manifests/ -n ${{ env.K8S_NAMESPACE }}
        echo "âœ… Manifests applied successfully"
        
    - name: Ensure deployment uses local image
      run: |
        echo "ğŸ”§ Ensuring deployment uses local image..."
        kubectl patch deployment django-deployment -n ${{ env.K8S_NAMESPACE }} \
          --type='json' \
          -p='[{"op": "replace", "path": "/spec/template/spec/containers/0/image", "value":"django-kubernetes-app:local"}]'
        echo "âœ… Deployment patched to use local image"
        
    - name: Restart deployment with new image
      run: |
        echo "ğŸ”„ Restarting deployment..."
        kubectl rollout restart deployment/django-deployment -n ${{ env.K8S_NAMESPACE }}
        echo "âœ… Deployment restart initiated"
        
    - name: Wait for pods stabilization
      run: |
        echo "â³ Waiting for pods to stabilize..."
        sleep 60
        echo "âœ… Wait completed"
        
    - name: Show deployment status
      run: |
        echo "ğŸ“Š Final deployment status:"
        echo "=== Pods ==="
        kubectl get pods -n ${{ env.K8S_NAMESPACE }}
        echo "=== Services ==="
        kubectl get svc -n ${{ env.K8S_NAMESPACE }}
        echo "=== Images in use ==="
        kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{range .items[*]}{.spec.containers[*].image}{"\n"}{end}' | sort | uniq
        
    - name: Cleanup old replicasets
      run: |
        echo "ğŸ§¹ Cleaning up old replicasets..."
        # ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ - ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ReplicaSet Ñ 0 Ñ€ĞµĞ¿Ğ»Ğ¸ĞºĞ°Ğ¼Ğ¸
        kubectl get replicaset -n ${{ env.K8S_NAMESPACE }} --selector=app=django-app --no-headers | \
        while read name desired current ready age rest; do
          if [ "$current" -eq "0" ]; then
            echo "Deleting replicaset: $name"
            kubectl delete replicaset $name -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true
          fi
        done
        echo "âœ… Cleanup completed"
        
    - name: Test application accessibility
      run: |
        echo "ğŸ§ª Testing application..."
        if curl -s http://django-app.local/health/ > /dev/null; then
          echo "âœ… Application is healthy and responding"
        else
          echo "âš ï¸  Application health check failed, but deployment completed"
        fi
        
    - name: Success message
      run: |
        echo "ğŸ‰ CI/CD Pipeline Completed Successfully!"
        echo "ğŸ“ Application URL: http://django-app.local"
        echo "ğŸ” Check status with: kubectl get pods -n django-app"
