name: Build, Push to Private Registry and Deploy with Helm

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: "192.168.49.2:30500"
  IMAGE_NAME: "django-app"
  K8S_NAMESPACE: "django-app"
  HELM_RELEASE: "django-app"

jobs:
  test:
    runs-on: ubuntu-latest  # ‚Üê –ò–∑–º–µ–Ω–∏–ª–∏ –Ω–∞ self-hosted
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip --no-warn-script-location
        pip install -r requirements.txt --no-warn-script-location
    - name: Run Django checks
      run: |
        python manage.py check
        python manage.py makemigrations --check --dry-run
    - name: Lint Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        ignore: DL3008,DL3015  # ‚Üê –î–æ–±–∞–≤–∏–ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
    - name: Test Docker build
      run: |
        docker build -t django-app-test .

  build-and-push:
    needs: test
    runs-on: self-hosted  # ‚Üê –î–æ–ª–∂–µ–Ω –±—ã—Ç—å self-hosted
    if: github.event_name == 'push'
    steps:
    - name: Clean workspace before checkout
      run: |
        echo "Cleaning workspace before checkout..."
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
        WORKSPACE_PATH="$HOME/actions-runner/_work/django-kubernetes-app/django-kubernetes-app"
        if [ -d "$WORKSPACE_PATH" ]; then
          echo "Removing old workspace: $WORKSPACE_PATH"
          sudo rm -rf "$WORKSPACE_PATH"
        fi
        # –°–æ–∑–¥–∞—ë–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
        sudo mkdir -p "$HOME/actions-runner/_work"
        sudo chown -R $USER:$(id -gn $USER) "$HOME/actions-runner/_work"
        sudo chmod -R 755 "$HOME/actions-runner/_work"
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to private registry
      run: |
        echo "Logging in to private registry ${{ env.REGISTRY }}"
        docker login ${{ env.REGISTRY }} -u admin -p admin123
        echo "‚úÖ Logged in successfully"
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
      env:
        DOCKER_BUILDKIT: 1
    
    - name: Verify pushed image
      run: |
        echo "Verifying image in registry..."
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        echo "‚úÖ Image verification complete"

  deploy-with-helm:
    needs: build-and-push
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Clean workspace before checkout
      run: |
        echo "Cleaning workspace before checkout..."
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
        WORKSPACE_PATH="$HOME/actions-runner/_work/django-kubernetes-app/django-kubernetes-app"
        if [ -d "$WORKSPACE_PATH" ]; then
          echo "Removing old workspace: $WORKSPACE_PATH"
          sudo rm -rf "$WORKSPACE_PATH"
        fi
        # –°–æ–∑–¥–∞—ë–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
        sudo mkdir -p "$HOME/actions-runner/_work"
        sudo chown -R $USER:$(id -gn $USER) "$HOME/actions-runner/_work"
        sudo chmod -R 755 "$HOME/actions-runner/_work"

    - uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: "3.12.0"
    
    - name: Verify Kubernetes cluster
      run: |
        echo "üîç Verifying Kubernetes cluster..."
        kubectl cluster-info
        kubectl get nodes
        kubectl get namespaces
        echo "‚úÖ Kubernetes cluster is accessible"
    
    - name: Add Helm repositories
      run: |
        echo "Adding Helm repositories..."
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update
        echo "‚úÖ Helm repositories added"
    
    - name: Create namespace if not exists
      run: |
        echo "Creating/verifying namespace..."
        kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
        echo "‚úÖ Namespace ready"
    
    - name: Create image pull secret for private registry
      run: |
        echo "Creating image pull secret..."
        kubectl create secret docker-registry private-registry-secret           --namespace=${{ env.K8S_NAMESPACE }}           --docker-server=${{ env.REGISTRY }}           --docker-username=admin           --docker-password=admin123           --docker-email=admin@example.com           --dry-run=client -o yaml | kubectl apply -f -
        echo "‚úÖ Image pull secret created"
    
    - name: Update Helm dependencies
      run: |
        echo "Updating Helm dependencies..."
        cd django-app-chart
        helm dependency update
        echo "‚úÖ Dependencies updated"
    
    - name: Deploy with Helm
      run: |
        echo "üöÄ Deploying with Helm..."
        helm upgrade --install ${{ env.HELM_RELEASE }} ./django-app-chart           --namespace ${{ env.K8S_NAMESPACE }}           --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}           --set image.tag=latest           --set postgresql.enabled=false           --set monitoring.enabled=true           --set logging.enabled=true           --set app.replicas=3           --set app.serviceType=NodePort           --set app.env.DEBUG="False"           --create-namespace           --wait           --timeout 300s
        echo "‚úÖ Helm deployment complete"
    
    - name: Check Helm status
      run: |
        echo "üìä Helm release status:"
        helm list --namespace ${{ env.K8S_NAMESPACE }}
        helm status ${{ env.HELM_RELEASE }} --namespace ${{ env.K8S_NAMESPACE }}
    
    - name: Show Kubernetes resources
      run: |
        echo "üìã Kubernetes resources status:"
        echo "=== Pods ==="
        kubectl get pods -n ${{ env.K8S_NAMESPACE }}
        echo "=== Services ==="
        kubectl get svc -n ${{ env.K8S_NAMESPACE }}
        echo "=== Deployments ==="
        kubectl get deployments -n ${{ env.K8S_NAMESPACE }}
        echo "=== ServiceMonitors ==="
        kubectl get servicemonitors -n ${{ env.K8S_NAMESPACE }} 2>/dev/null || echo "No ServiceMonitors found"
    
    - name: Run database migrations
      run: |
        echo "üóÑÔ∏è Running database migrations..."
        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø–æ–¥–æ–≤
        sleep 30
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –æ–¥–Ω–æ–≥–æ –∏–∑ –ø–æ–¥–æ–≤
        POD_NAME=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l "app.kubernetes.io/name=django-app" -o jsonpath='{.items[0].metadata.name}' --field-selector=status.phase=Running)
        
        if [ -n "$POD_NAME" ]; then
          echo "Running migrations on pod: $POD_NAME"
          kubectl exec -n ${{ env.K8S_NAMESPACE }} $POD_NAME -- python manage.py migrate --noinput
          echo "‚úÖ Migrations completed"
          
          echo "Collecting static files..."
          kubectl exec -n ${{ env.K8S_NAMESPACE }} $POD_NAME -- python manage.py collectstatic --noinput
          echo "‚úÖ Static files collected"
        else
          echo "‚ö†Ô∏è No running pods found for migrations"
        fi
    
    - name: Wait for rollout to complete
      run: |
        echo "‚è≥ Waiting for rollout to complete..."
        kubectl rollout status deployment/${{ env.HELM_RELEASE }} -n ${{ env.K8S_NAMESPACE }} --timeout=300s
        echo "‚úÖ Rollout completed successfully"
    
    - name: Cleanup old resources
      run: |
        echo "üßπ Cleaning up old resources..."
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ ReplicaSets
        kubectl get replicaset -n ${{ env.K8S_NAMESPACE }} --no-headers |         while read name desired current ready age rest; do
          if [ "$current" -eq "0" ]; then
            echo "Deleting replicaset: $name"
            kubectl delete replicaset $name -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true
          fi
        done
        echo "‚úÖ Cleanup completed"

  smoke-test:
    needs: deploy-with-helm
    runs-on: self-hosted
    steps:
    - name: Clean workspace before checkout
      run: |
        echo "Cleaning workspace before checkout..."
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
        WORKSPACE_PATH="$HOME/actions-runner/_work/django-kubernetes-app/django-kubernetes-app"
        if [ -d "$WORKSPACE_PATH" ]; then
          echo "Removing old workspace: $WORKSPACE_PATH"
          sudo rm -rf "$WORKSPACE_PATH"
        fi
        # –°–æ–∑–¥–∞—ë–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
        sudo mkdir -p "$HOME/actions-runner/_work"
        sudo chown -R $USER:$(id -gn $USER) "$HOME/actions-runner/_work"
        sudo chmod -R 755 "$HOME/actions-runner/_work"
    - name: Perform smoke tests
      run: |
        echo "üß™ Performing smoke tests..."
        
        # –ü–æ–ª—É—á–∞–µ–º NodePort —Å–µ—Ä–≤–∏—Å–∞
        NODE_PORT=$(kubectl get svc -n ${{ env.K8S_NAMESPACE }} ${{ env.HELM_RELEASE }} -o jsonpath='{.spec.ports[0].nodePort}')
        MINIKUBE_IP=$(minikube ip)
        
        echo "Testing application at http://$MINIKUBE_IP:$NODE_PORT"
        
        # –¢–µ—Å—Ç health endpoint
        echo "1. Testing health endpoint..."
        HEALTH_RESPONSE=$(curl -s -f http://$MINIKUBE_IP:$NODE_PORT/health/ || echo "FAILED")
        if [ "$HEALTH_RESPONSE" != "FAILED" ]; then
          echo "‚úÖ Health endpoint: OK"
          echo "   Response: $HEALTH_RESPONSE"
        else
          echo "‚ùå Health endpoint: FAILED"
          exit 1
        fi
        
        # –¢–µ—Å—Ç metrics endpoint
        echo "2. Testing metrics endpoint..."
        METRICS_RESPONSE=$(curl -s -f http://$MINIKUBE_IP:$NODE_PORT/metrics || echo "FAILED")
        if [ "$METRICS_RESPONSE" != "FAILED" ]; then
          echo "‚úÖ Metrics endpoint: OK"
          echo "   Found $(echo "$METRICS_RESPONSE" | grep -c '^django_') Django metrics"
        else
          echo "‚ö†Ô∏è Metrics endpoint: Not accessible (may need prometheus installed)"
        fi
        
        # –¢–µ—Å—Ç –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
        echo "3. Testing load balancing..."
        echo "   Sending 5 requests to check load balancing:"
        for i in {1..5}; do
          RESPONSE=$(curl -s http://$MINIKUBE_IP:$NODE_PORT/health/)
          echo "   Request $i: $RESPONSE"
          sleep 0.5
        done
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Prometheus
        echo "4. Checking Prometheus integration..."
        if kubectl get servicemonitor -n ${{ env.K8S_NAMESPACE }} ${{ env.HELM_RELEASE }} > /dev/null 2>&1; then
          echo "‚úÖ ServiceMonitor exists"
        else
          echo "‚ö†Ô∏è ServiceMonitor not found"
        fi
        
        echo "üéâ All smoke tests passed!"

  monitoring-check:
    needs: deploy-with-helm
    runs-on: self-hosted
    steps:
    - name: Clean workspace before checkout
      run: |
        echo "Cleaning workspace before checkout..."
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
        WORKSPACE_PATH="$HOME/actions-runner/_work/django-kubernetes-app/django-kubernetes-app"
        if [ -d "$WORKSPACE_PATH" ]; then
          echo "Removing old workspace: $WORKSPACE_PATH"
          sudo rm -rf "$WORKSPACE_PATH"
        fi
        # –°–æ–∑–¥–∞—ë–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
        sudo mkdir -p "$HOME/actions-runner/_work"
        sudo chown -R $USER:$(id -gn $USER) "$HOME/actions-runner/_work"
        sudo chmod -R 755 "$HOME/actions-runner/_work"
    - name: Check monitoring stack
      run: |
        echo "üìä Checking monitoring stack..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ Prometheus
        echo "1. Prometheus status:"
        kubectl get pods -n monitoring -l "app.kubernetes.io/name=prometheus" 2>/dev/null || echo "Prometheus not found in monitoring namespace"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ Grafana
        echo "2. Grafana status:"
        kubectl get pods -n monitoring -l "app.kubernetes.io/name=grafana" 2>/dev/null || echo "Grafana not found"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ Loki
        echo "3. Loki status:"
        kubectl get pods -n monitoring -l "app.kubernetes.io/name=loki" 2>/dev/null || echo "Loki not found"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ Fluent Bit
        echo "4. Fluent Bit status:"
        kubectl get pods -n monitoring -l "app.kubernetes.io/name=fluent-bit" 2>/dev/null || echo "Fluent Bit not found"
        
        echo "‚úÖ Monitoring check completed"

  success-notification:
    needs: [smoke-test, monitoring-check]
    runs-on: self-hosted
    if: success()
    steps:
    - name: Clean workspace before checkout
      run: |
        echo "Cleaning workspace before checkout..."
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
        WORKSPACE_PATH="$HOME/actions-runner/_work/django-kubernetes-app/django-kubernetes-app"
        if [ -d "$WORKSPACE_PATH" ]; then
          echo "Removing old workspace: $WORKSPACE_PATH"
          sudo rm -rf "$WORKSPACE_PATH"
        fi
        # –°–æ–∑–¥–∞—ë–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
        sudo mkdir -p "$HOME/actions-runner/_work"
        sudo chown -R $USER:$(id -gn $USER) "$HOME/actions-runner/_work"
        sudo chmod -R 755 "$HOME/actions-runner/_work"
    - name: Success message
      run: |
        echo "üéâ CI/CD Pipeline for Practice #4 Completed Successfully!"
        echo ""
        echo "üìä DEPLOYMENT SUMMARY:"
        echo "======================"
        echo "‚úÖ Application deployed with Helm"
        echo "‚úÖ Private registry integration"
        echo "‚úÖ Monitoring stack (Prometheus/Grafana)"
        echo "‚úÖ Logging stack (Loki/Fluent Bit)"
        echo "‚úÖ Health checks and smoke tests passed"
        echo ""
        echo "üîó Access URLs:"
        echo "   - Django App: http://$(minikube ip):$(kubectl get svc -n ${{ env.K8S_NAMESPACE }} ${{ env.HELM_RELEASE }} -o jsonpath='{.spec.ports[0].nodePort}')"
        echo "   - Grafana: http://localhost:3000 (after port-forward)"
        echo "   - Prometheus: http://localhost:9090 (after port-forward)"
        echo ""
        echo "üìù Commands to check status:"
        echo "   kubectl get all -n ${{ env.K8S_NAMESPACE }}"
        echo "   helm list -n ${{ env.K8S_NAMESPACE }}"
        echo "   kubectl get pods -n monitoring"
